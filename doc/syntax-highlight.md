; -*- mode : lisp ; -*-

Раскраска (старая версия)
=========

Видимо, нужно найти примитивы раскраски, которые используются в одуванчике и перешибить их. Все примитивы раскраски, применённые после принятого из tcl редактирования N, должны записываться в очередь. Когда tcl присылает следующее редактирование N+1, мы говорим ему: посоревнуйся сперва с моим младшим братом. Отправляем tcl-ю все примитивы раскраски, он их применяет. После этого мы выполняем в лиспе редактирование N+1. 

Если пользователь не трогает текст, то tcl должен запросить её по таймеру. Пока не пытаемся оптимизировать раскраску, поскольку для файлов до 100 кб она работает достаточно быстро. За счёт блокировки буфера на время обращения к лиспу у нас гарантировано совпадение буферов tcl и одуванчика в процессе обмена данными, значит нет проблемы, что при передаче первой раскраски придёт слишком много данных и раскраска займёт время. 


Раскраска (упрощённая версия)
=========

1. Нужно запустить фоновую раскраску после открытия файла. Видимо, в отдельном треде. Видимо, нужно блокировать момент записи. 
2. После каждого редактирования нужно сбрасывать существующую раскраску и заново запускать овую. пока что мы не трогаем старую, а новую запускаем. Это баг. 

### Тред диспетчера раскраски


oi::line-tag -> ... -> oi::recompute-syntax-marks -> clco::notify-highlight-single-line -> кладёт в очередь

вызывается из: oi::line-syntax-info, odu::package-at-point, oi::sync-dis-line-tag -
из них sync-dis-line-tag отключил (и ещё что-то отключил).

Т.е. можно сказать ниоткуда не вызывается. 


Два сценария раскраски - фоновый и синхронный
--------------
Точка входа осталась у нас одна - line-tag -> oi::recompute-tags-up-to
В видимом одуванчике их больше. 
Есть два варианта:
- фоновый запуск - ни на что не влияет, должен быть способ его отменить.
мы должны запускать фоновую раскраску после каждого редактирования, указав диапазон, где
нужно обязательно всё переделать, а где можно так оставить (хотя вроде это и так получится, т.е. можно всегда раскрашивать до конца. Точно до конца, поскольку кавычка в начале файла влияет на весь остаток файла. А вот раскрашивать не с начала наверное, можно, но мы пока этого не делаем. 


Раскраску в основном кидаем во входную очередь ( odu::recompute-line-tags-starting-from-line-background ) , хотя часть делаем сразу (с надеждой, что не сломается).

Также (потом будет) функция отменить фоновый процесс раскраски, если что-то поменялось. План реализации отмены написан в ошибке #102 . Топологику надо продумать. 
                                                                 
- принудительный запуск - когда мы должны дождаться результата. Например, из package-at-point. 


Подсветка скобок
------------
odu::maybe-highlight-open-parens - a redisplay hook that matches parens by highlighting the corresponding open-paren after a close-paren is typed

вопрос в том, вызывается ли он при хождении по скобкам? 

See also
========
text2odu.md
